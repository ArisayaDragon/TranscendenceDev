<?xml version="1.0" encoding="utf-8"?>

<TranscendenceModule>

	<!-- Raisu Station -->

	<StationType UNID="&stRaisuStation;"
			name=				": Raisu Station"
			sovereign=			"&svCommonwealth;"
			inherit=			"&baCommonwealthStation;"

			dockScreen=			"Main"
			abandonedScreen=	"&dsAbandonedStation;"
			canAttack=			"true"

			level=				"3"
			multiHull=			"true"
			armorID=			"&itPlasteelPlate;"
			hitPoints=			"150"
			regen=				"1"
			ejectaType=			"&vtWreckEjecta;"

			attributes=			"commonwealth, commonwealthCustoms, friendly, human, majorStation, occupation, populated, raisuStation"
			>

		<ImageVariants>
			<Image	imageID="&rsCommonwealthSlumsImage;" imageX="0" imageY="0" imageWidth="64" imageHeight="128"/>
			<Image	imageID="&rsCommonwealthSlumsImage;" imageX="64" imageY="0" imageWidth="64" imageHeight="128"/>
			<Image	imageID="&rsCommonwealthSlumsImage;" imageX="128" imageY="0" imageWidth="64" imageHeight="128"/>
			<Image	imageID="&rsCommonwealthSlumsImage;" imageX="192" imageY="0" imageWidth="64" imageHeight="128"/>
		</ImageVariants>

		<!-- Ships and Defenses -->

		<Ships challenge="standard">
			<Lookup table="&tbCommPrivateCrafts;"/>
		</Ships>

		<DockScreens>
			<Main>
				<Panes>
					<Default descID="descNormal">
						<Actions>
							<Action id="actionMainHall" default="1">
								(rpgMissionAssignment {
									missionCriteria: "n +commonwealthHabitat;"
									maxActive: 1
									intervalPerType: (+ 5400 (* (objGetDestiny gSource) 10))
									noMissionTextID: 'descNoMissions
									})
							</Action>

							<Action id="actionUndock" cancel="1">
								<Exit/>
							</Action>
						</Actions>
					</Default>
				</Panes>
			</Main>
		</DockScreens>

		<DockingPorts>
			<Port x="0"		y="80" />
			<Port x="43"	y="56" />
			<Port x="52"	y="8" />
			<Port x="35"	y="-44" />
			<Port x="-35"	y="-44" />
			<Port x="-52"	y="8" />
			<Port x="-43"	y="56" />
		</DockingPorts>

		<Language>
			<Text id="descNormal">

				The loud voices of a packed multitude bounce off every bulkhead and corridor in the station.
				Old air scrubbers pump a thin, odorous breeze out of rusty vents. Discarded packets of
				Salmonite and Red Nebula beer huddle in the corner.

				Welcome to Raisu Station!

			</Text>
		</Language>
	</StationType>

	<!-- Mission: Liberate Raisu station =======================================

	EXTRA DATA

	status:		Status of Raisu station
					Nil						= Controlled by Centauri Warlords
					'destroyed				= Destroyed
					'destroyedByPlayer		= Destroyed by player
					'liberated				= Liberated

	targetID:				ID of ship to destroy (Arco Vaughn)
	raidersSummoned:		Number of raiders summoned to station

	======================================================================== -->

	<MissionType UNID="&msRaisuStation;"
			name=				"Liberate Raisu station"
			attributes=			"commonwealth, special, deliveryMission"

			level=				"1"

			priority=			"10"
			maxAppearing=		"1"
			recordNonPlayer=	"true"
			>

		<Events>
			<OnCreate>
				(block (
					(arcoVaughn (sysFindObject gSource "sN +arcoVaughn;"))
					)
					(switch
						(not arcoVaughn)
							(msnDestroy gSource)

						(block Nil
							(msnSetData gSource 'destID (objGetID aOwnerObj))

							;	Remove Commonwealth ships
							(objSetProperty aOwnerObj 'shipReinforcementEnabled Nil)
							(enum (sysFindObject aOwnerObj "sO:docked;") theShip (objDestroy theShip))

							;	Disable Commonwealth customs
							(objSetEventHandler aOwnerObj &evCentauriOccupation;)

							;	Add Centauri Raiders
							(for i 1 (random 4 5)
								(block (theShip)
									(setq theShip (sysCreateShip &scCentauriRaider; aOwnerObj &svCentauriWarlords;))
									(shpOrder theShip 'patrol aOwnerObj 10)
									)
								)

							(msnSetData gSource 'targetID (objGetID arcoVaughn))
							(msnRegisterForEvents gSource arcoVaughn)

							;	Updates
							(msnAddRecurringTimerEvent gSource 451 'OnTimer)
							)
						)
					)
			</OnCreate>

			<OnAccepted>
				(block (theItem launcherItem missileTypes bestType)
					;	Give the player some appropriate missiles
					(switch
						;	If we don't have a launcher, give a missile rack
						(not (setq launcherItem (@ (objGetItems gPlayerShip "lI -Disposable;") 0)))
							(setq theItem (itmCreate &itDM1500MissileRack; 1))

						;	Find all compatible missiles for this launcher
						(not (setq missileTypes (itmGetTypes (cat "M +launchedBy:" (itmGetType launcherItem) ";"))))
							(setq theItem (itmCreate &itDM1500MissileRack; 1))

						;	Find a tracking missile of level 3 or less.
						(setq bestType
								(map missileTypes (list 'reduceMax 'original 'excludeNil) theType
									(if (and (itmGetProperty theType 'tracking)
											(leq (itmGetLevel theType) 3)
											)
										(itmGetLevel theType)
										)
									)
								)
							(setq theItem (itmCreate bestType (random 32 48)))

						;	Otherwise, any missile of level 5 or less.
						(setq bestType
								(map missileTypes (list 'reduceMax 'original 'excludeNil) theType
									(if (leq (itmGetLevel theType) 5)
										(itmGetLevel theType)
										)
									)
								)
							(setq theItem (itmCreate bestType (random 32 48)))

						;	Otherwise, default to a missile rack
						(setq theItem (itmCreate &itDM1500MissileRack; 1))
						)
					(objAddItem gPlayerShip theItem)
					(msnSetData gSource 'theItem theItem)
					)
			</OnAccepted>

			<OnSetPlayerTarget>
				(rpgSetTarget gSource aReason (objGetObjByID (msnGetData gSource 'targetID)))
			</OnSetPlayerTarget>

			<OnTimer>
				(block (
					(stationObj (objGetObjByID (msnGetProperty gSource 'ownerID)))
					)
					(switch
						;	If not in Starton Eridani, then nothing to do
						(!= (sysGetNode) (msnGetProperty gSource 'nodeID))
							Nil

						;	If we currently have raiders, then nothing to do
						(sysFindObject stationObj "s +centauriWarlords; N:150")
							Nil

						;	If we've already summoned lots of raiders, then send Arco Vaughn
						(gr (msnGetData gSource 'raidersSummoned) 20)
							(block (arcoVaughn)
								(setq arcoVaughn (sysFindObject stationObj "sN +arcoVaughn;"))
								(if arcoVaughn
									(objFireEvent arcoVaughn "OrderKillPlayer")
									)
								)

						;	Otherwise summon some more raiders
						(leq (random 1 100) 20)
							(for i 1 (random 3 4)
								(block (theShip)
									(setq theShip
										(sysCreateShip &scCentauriRaider;
											(sysFindObject stationObj "GN -uncharted;")
											&svCentauriWarlords;
											)
										)
									(shpOrder theShip 'patrol stationObj 10)
									(msnIncData gSource 'raidersSummoned)
									)
								)
							)
						)
					)
			</OnTimer>

			<OnObjDestroyed>
				(switch
					(= (objGetID aObjDestroyed) (msnGetProperty gSource 'ownerID))
						(block Nil
							;	If the mission is still open we need to make it a non-player mission
							(msnSetUnavailable gSource)
							(msnFailure gSource {
								destroyedByPlayer: (and gPlayerShip (= aOrderGiver gPlayerShip))
								})
							)

					(= (objGetID aObjDestroyed) (msnGetData gSource 'targetID))
						(block Nil
							;	If the mission is still open we need to make it a non-player mission
							(msnSetUnavailable gSource)
							(msnSuccess gSource)
							)
					)
			</OnObjDestroyed>

			<OnCompleted>
				(switch
					(= aReason 'success)
						(block (
							(stationObj (objGetObjByID (msnGetProperty gSource 'ownerID)))
							)
							(msnSetData gSource 'status 'liberated)
							(objSetProperty stationObj 'shipReinforcementEnabled True)
							(objSetEventHandler stationObj Nil)
							)

					(and (= aReason 'failure) (@ gData 'destroyedByPlayer))
						(msnSetData gSource 'status 'destroyedByPlayer)

					(= aReason 'failure)
						(msnSetData gSource 'status 'destroyed)
					)
			</OnCompleted>

			<OnCanBrief>
				(block (
					(stationObj (objGetObjByID (msnGetProperty gSource 'ownerID)))
					(centauriDestroyed (count (sysFindObject gPlayerShip "TK +centauriWarlords; +populated; -occupation; -uncharted;")))
					)

					(switch
						;	If the player declined, then everyone is still in fear
						(msnGetProperty gSource 'isDeclined)
							(msnTranslate gSource 'descMissionHiding)

						;	If there are Centauri raiders in range, then everyone is hinding
						(sysFindObject stationObj "s +centauriWarlords; N:100;")
							(msnTranslate gSource 'descMissionHiding)

						;	If all stations have been destroyed, then the player gets the mission
						(not (sysFindObject gPlayerShip "TA +centauriWarlords; +populated; -occupation; -uncharted;"))
							Nil

						;	Check the number of destroyed Centauri stations
						(= centauriDestroyed 0)
							(msnTranslate gSource 'descStationFearful0)

						(= centauriDestroyed 1)
							(msnTranslate gSource 'descStationFearful1)

						(= centauriDestroyed 2)
							(msnTranslate gSource 'descStationFearful2)

						;	Otherwise player gets the mission
						Nil
						)
					)
			</OnCanBrief>

			<OnDeliveryMissionCompleted>
				{
					desc: (msnTranslate gSource 'descHiding)
					forceUndock: True
					}
			</OnDeliveryMissionCompleted>

			<OnGlobalSystemStarted>
				(block (raisuObj)
					(switch
						;	Only create in Starton Eridani
						(!= (sysGetNode) 'SE)
							Nil

						;	Only create one
						(msnFind "* +unid:&msRaisuStation;;")
							Nil

						(not (setq raisuObj (sysFindObject Nil "TAN +unid:&stRaisuStation;;")))
							Nil

						(msnCreate &msRaisuStation; raisuObj)
						)
					)
			</OnGlobalSystemStarted>

			<GetGlobalAchievements>
				(block (theMission theStatus)
					(if (and
							(setq theMission (msnFind "P* +unid:&msRaisuStation;;"))
							(setq theStatus (msnGetData theMission 'status))
							)
						(list
							(list
								(or (msnTranslate theMission (cat "achievement." theStatus))
									(cat "ERROR: Raisu station status: " theStatus)
									)
								Nil
								(typTranslate &unidCommonText; 'achievementsAndRegrets)
								)
							)
						)
					)
			</GetGlobalAchievements>

			<GetRumors>
				(switch
					(!= (msnGetProperty gSource 'nodeID) (sysGetNode))
						Nil

					(= (msnGetProperty gSource 'ownerID) (objGetID (@ gData 'stationObj)))
						(if (msnGetProperty gSource 'isSuccess)
							{
								attributes: 'commonwealthHabitat
								priority: 10000
								sourceObj: gSource
								dialogID: 'descMeetingHallHappy
								}
							)

					(msnGetProperty gSource 'isSuccess)
						(rpgRumorAdd 'commonwealthHabitat (make 'sequence 5 8) 20)

					(msnGetProperty gSource 'isFailure)
						Nil

					(rpgRumorAdd 'commonwealthHabitat (make 'sequence 1 4) 20)
					)
			</GetRumors>
		</Events>


		<Language>
			<!-- Code Points -->

			<Text id="Summary">
				(cat
					(msnTranslate gSource 'descSummary)
					"\n\n"
					(typTranslate &dsRPGMission; 'mission.rewardSummary {
						systemName: (sysGetName)
						payment: (fmtCurrency 'credit (msnGetData gSource 'reward))
						})
					)
			</Text>

			<Text id="AcceptReply">
				(block (
					(theItem (msnGetData gSource 'theItem))
					)
					(if (gr (itmGetCount theItem) 1)
						(msnTranslate gSource 'descMissionAcceptPlural { itemName:(itmGetName theItem 'plural) })
						(msnTranslate gSource 'descMissionAcceptSingular { itemName:(itmGetName theItem) })
						)
					)
			</Text>

			<Text id="InProgress">
				(msnTranslate gSource 'descMissionHiding)
			</Text>

			<Text id="SuccessDebrief">
				(if (= (plyGetGenome gPlayer) 'humanMale)
					(msnTranslate gSource 'descMissionSuccessWhisper)
					(msnTranslate gSource 'descMissionSuccessHug)
					)
			</Text>

			<!-- Text -->

			<Text id="Name">Kill Arco Vaughn</Text>
			<Text id="descSummary">

				Centauri warlords have taken over Raisu station. Help free the station by
				killing the warlord Arco Vaughn.

			</Text>
			<Text id="descHiding">

				The docking bay is completely empty. Old air scrubbers pump a thin, odorous breeze out of
				rusty vents. Discarded packets of Salmonite and Red Nebula beer huddle in the corner.

			</Text>

			<Text id="descStationFearful0">

				The station master stands at her console. She turns her attention towards you:

				"You'd better leave before the warlords return. If they see an armed ship here they will 
				kill you; and we will be punished. Go now!"

			</Text>
			<Text id="descStationFearful1">

				The station master stands at her console. She turns her attention towards you:

				"The Centauri warlords are furious that you've blown up one of their stations! 
				Do you really think you're strong enough to stand up to them?! Please leave before 
				you get us all killed!"

			</Text>
			<Text id="descStationFearful2">

				The station master stands at her console. She turns her attention towards you:

				"Please leave! You know what will happen if you try to destroy more Centauri 
				bases? You'll be killed and we'll be punished! And if Arco Vaughn sees you here, 
				we're all dead!"

			</Text>
			<Text id="descMeetingHallHappy">

				The meeting hall is busy with commercial activity; everyone goes about their 
				business, sometimes stopping to say hello to you.

			</Text>

			<Text id="Intro">

				The station master stands at her console. She runs towards you tearfully:

				"Is it true? Have you fought the Centauri warlords? It's been so long since 
				anyone stood up to them. Will you finish what you've begun? If you don't 
				kill the rest of them now, we'll be the ones who suffer.
				
				"Arco Vaughn is the key. Kill him and the rest will leave us alone."

			</Text>
			<Text id="Briefing">

				"I can help you; I'm not afraid anymore. Arco Vaughn lives deep in the outer
				belt&#x97;I can give you the coordinates. Kill him and we will all be free.

				"Will you help us?"

			</Text>
			<Text id="descMissionAcceptSingular">

				"You will need all the power you can to kill him. I have a hidden %itemName%
				that the warlords never found. It belonged to my husband...many years ago.
				Take it! Take it and good luck!"

				She hugs you quickly and runs off.

			</Text>
			<Text id="descMissionAcceptPlural">

				"You will need all the power you can to kill him. I have some hidden %itemName%
				that the warlords never found. They belonged to my husband...many years ago.
				Take them! Take them and good luck!"

				She hugs you quickly and runs off.

			</Text>
			<Text id="DeclineReply">

				The station master stares at you in shock and then begins to weep.

				"Why did you start this war if you won't finish it! You've doomed us all!"

			</Text>
			<Text id="descMissionHiding">

				The station master's console is empty. Everyone on the station is hiding in 
				the central hub.

			</Text>
			<Text id="descMissionSuccessWhisper">

				The station master runs towards you; she puts her arms around you as the rest 
				of the citizens come out of hiding.

				"You did it! I never thought I would live to see it! You've freed us from the 
				warlords!"

				She hugs you again and whispers her name in your ear.

			</Text>
			<Text id="descMissionSuccessHug">

				The station master runs towards you; she puts her arms around you as the rest 
				of the citizens come out of hiding.

				"You did it! I never thought I would live to see it! You've freed us from the
				warlords!"

				She beams a smile and hugs you again.

			</Text>

			<Text id="rumor.commonwealthHabitat.1">
				"The warlords are annoying, but they don't mean much. The only one that bothers
				me is Arco Vaughn. He's trouble. Someone ought to air him out before things get
				out of hand, you know?"
			</Text>
			<Text id="rumor.commonwealthHabitat.2">
				"It's sad about Raisu station, isn't it? If a corporate fuel station got taken
				over by Centauri warlords they'd have Admiral Decker himself leading the
				rescue. But no one cares about a poor, backwater station, I guess."
			</Text>
			<Text id="rumor.commonwealthHabitat.3">
				"If you're looking for Arco Vaughn, go to Raisu station: the station master
				there will help you out. But first you gotta convince her that you're serious."
			</Text>
			<Text id="rumor.commonwealthHabitat.4">
				"If you need help against Arco Vaughn the station master at Raisu station will
				help you. But you'll have to prove that you're serious. Take out a few Centauri
				stations and you might convince her."
			</Text>
			<Text id="rumor.commonwealthHabitat.5">
				"Thank heavens that someone finally killed Arco Vaughn. Maybe now the warlords
				will leave us alone."
			</Text>
			<Text id="rumor.commonwealthHabitat.6">
				"It's shame what Raisu station had to go through, isn't it? If a corporate
				station had been occupied by warlords, they'd have sent Admiral Decker himself
				to lead the rescue. But no one cares about a poor, backwater station, I guess."
			</Text>
			<Text id="rumor.commonwealthHabitat.7">
				"I hear that Arco Vaughn is finally dead. No one will mourn him. I really feel
				for Erica and her team at Raisu&mdash;they went through hell."
			</Text>
			<Text id="rumor.commonwealthHabitat.8">
				"We're all glad that Arco Vaughn is dead. I heard someone from Raisu station
				finally had enough and decided to chase him down."
			</Text>

			<Text id="achievement.liberated">Liberated Raisu station</Text>
			<Text id="achievement.destroyed">Allowed Raisu station to be destroyed</Text>
			<Text id="achievement.destroyedByPlayer">Destroyed Raisu station</Text>
		</Language>
	</MissionType>

<!-- BEHAVIORS -->

	<Type UNID="&evCentauriOccupation;">
		<Events>
			<GetCommonwealthCustomsStatus>
				'disabled
			</GetCommonwealthCustomsStatus>
		</Events>
	</Type>

</TranscendenceModule>
