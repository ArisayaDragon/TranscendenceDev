<?xml version="1.0" encoding="utf-8"?>

<TranscendenceModule>
	
	<!-- Professor Dall's Mission =========================================

	EXTRA DATA

	declineReason:			Flag to indicate why player declined mission

	status:					Mission state:
		Nil					Never encountered
		'declined			Player declined the mission
		'needBetterShip		Player wants to upgrade first
		'inProgress			Player is looking for the sphere
		'success			Professor Dall got his artifact

	======================================================================== -->
	
	<MissionType UNID="&msDallSphere;"
			name=				"Dall Sphere"
			attributes=			"stKatsTaikon"

			level=				"4"
			maxAppearing=		"1"
			noDebrief=			"true"
			>

		<Events>
			<OnCreate>
			</OnCreate>

			<OnAccepted>
				(block (theWreck)
					;	For now we create the wreck only when the mission
					;	starts (because we are too lazy to deal with the
					;	alternatives, such as the player finding the wreck
					;	before she talks to the professor).
					
					(setq theWreck (sysCreateStation 
						&stDallMissionWreck;
						(sysVectorRandom Nil (random 800 1200) 300)
						))
					(msnSetData gSource 'targetID (objGetID theWreck))
						
					;	The sphere is in the universe
					(typSetData &itDallSphere; 'status 'onFreighter)
					
					;	Start
					(msnSetData gSource 'status 'inProgress)
					)
			</OnAccepted>

			<OnDeclined>
				(block Nil
					(msnSetData gSource 'status (or (msnGetData gSource 'declineReason) 'declined))
					(msnSetData gSource 'declineReason Nil)
					)
			</OnDeclined>

			<OnSetPlayerTarget>
				(rpgSetTarget gSource aReason (objGetObjByID (msnGetData gSource 'targetID)) 'dock)
			</OnSetPlayerTarget>
			
			<OnInProgress>
				(block (theSphere)
					(if (setq theSphere (@ (objGetItems gPlayerShip "* +unid:&itDallSphere;") 0))
						(block Nil
							(objRemoveItem gPlayerShip theSphere)
							(typSetData &itDallSphere; 'status 'withDall)
							
							;	Update status so we show the correct dockscreen text
							(msnSetData gSource 'status 'success)
							
							;	Complete the mission and reward the player
							(msnSuccess gSource)
							(msnReward gSource)
							)
						)
					)
			</OnInProgress>

			<OnReward>
				(objAddItem gPlayerShip (itmCreate &itExplorerAuton; 1))
			</OnReward>
		</Events>
		
		<Language>
			<Text id="Name">"Professor Dall's sphere"</Text>
			<Text id="Summary">
				(cat
					"Professor Dall has asked you to search for an alien sphere on a Sung freighter lost the outer system.\n\n"

					"System: " (sysGetName) "\n"
					"Payment: " (fmtCurrency 'credit (msnGetData gSource 'reward))
					)
			</Text>
			<Text id="Intro">
				(if (= (objGetProperty gPlayerShip 'characterClass) &unidPilgrimClass;)
					(msnTranslate gSource 'dallWelcomePilgrim)
					(msnTranslate gSource 'dallWelcome)
					)
			</Text>
			<Text id="Briefing">
				(switch
					(= (msnGetData gSource 'status) 'declined)
						(msnTranslate gSource 'dallBriefing)

					(not (objGetItems gPlayerShip "sIN &gt;=5"))
						(list
							{	desc: (msnTranslate gSource 'dallShieldCheck)
								actions: (list
									{	label: (msnTranslate gSource 'actionDontWorry)	}
									{	label: (msnTranslate gSource 'actionBeBack)
										nextPage: 'missionDecline
										code: (lambda Nil (msnSetData (scrGetData gScreen 'missionObj) 'declineReason 'needBetterShip))
										}
									)
								}
							(msnTranslate gSource 'dallBriefingFirst)
							)

					(= (msnGetData gSource 'status) 'needBetterShip)
						(list
							(msnTranslate gSource 'dallBetterShip)
							(msnTranslate gSource 'dallBriefingFirst)
							)

					(list
						(msnTranslate gSource 'dallBriefing)
						)
					)
			</Text>
			<Text id="AcceptReply">
				(cat
					"\"I've made the calculations dozens of times; I'm sure of it. I've programmed the "
					"location of the freighter into your computer. All you have to do is bring back the "
					"sphere. I'd go myself, but I wouldn't do well in combat.\"\n\n"

					"\"Good luck!\""
					)
			</Text>
			<Text id="DeclineReply">
				(if (= (msnGetData gSource 'status) 'needBetterShip)
					(msnTranslate gSource 'dallComebackWhenReady)
					(msnTranslate gSource 'dallDeclineReply)
					)
			</Text>
			<Text id="InProgress">
				(if (= (msnGetData gSource 'status) 'success)
					(msnTranslate gSource 'dallSuccess)
					(msnTranslate gSource 'dallInProgress)
					)
			</Text>

			<Text id="dallWelcome">
				(cat
					"You meet one of the faculty members of the Taikon School:\n\n"
					
					"\"I'm Professor Dall. Who are you? An explorer? A mercenary? Well, it doesn't matter to me.\"\n\n"
					
					"\"I need you to fetch something for me; something that's been lost for a long time but now I've found. "
					"You may have to fight for it, of course, but I'm sure you're used to that, right?\""
					)				
			</Text>
			<Text id="dallWelcomePilgrim">
				(cat
					"You meet one of the faculty members of the Taikon School:\n\n"
					
					"\"I'm Professor Dall. Who are you? Another pilgrim? Many pass through here, always searching but not finding. "
					"But I can help you, if you help me in turn.\"\n\n"
					
					"\"I need you to fetch something for me; something that's been lost for a long time but now I've found. "
					"You may have to fight for it, of course, but I'm sure you're used to that. "
					"And it'll be nothing compared to what you're going to have to face, am I right?\""
					)				
			</Text>
			<Text id="dallShieldCheck">
				(cat
					"\"You are ready for combat are you not? I mean, I don't want to trust this discovery "
					"to an unready ship or captain.\"\n\n"

					"\"I expect a ship to need level 5 shields or higher to survive the dangers at the "
					"edge of the system. I hope you're prepared.\""
					)
			</Text>
			<Text id="dallComebackWhenReady">
				(cat
					"\"I've waited for twenty years, I can wait a bit longer. "
					"Come back when your ship is ready for the mission.\""
					)
			</Text>
			<Text id="dallBetterShip">
				(cat
					"\"You're back! Hopefully you're ready for the mission now.\""
					)
			</Text>
			<Text id="dallBriefing">
				(cat
					"Professor Dall greets you:\n\n"

					"\"So you're back! Couldn't get stories of freighters carrying treasure out of your mind, am I right? "
					"Well I'm still willing to help you if you fetch the artifact for me. Once they see what I've found they'll "
					"have to pay attention!\n\n"

					"\"What do you say?\""
					)
			</Text>
			<Text id="dallBriefingFirst">
				(cat
					"\"I'm looking for a very special cargo on a wrecked freighter out beyond Fulgent. "
					"Two-hundred years ago the Huari found a magnificent object; an alien sphere left behind by who knows what race. "
					"When the Sung arrived the Huari records were lost and with it the sphere. But according to a cryptic Sung memo, "
					"it was found again; a freighter carrying the prize was dispatched to Jiang's Star, but it never arrived.\"\n\n"

					"\"Now I'm the only one who knows where the freighter ended up. And I can tell you how to find it!\""
					)
			</Text>
			<Text id="dallDeclineReply">
				(cat
					"The professor looks down at his papers.\n\n"

					"\"Well, I don't expect you to believe me. But I know it's out there. "
					"It's out there and I'm going to find it. Twenty years I've spent looking; "
					"twenty years of calculations and research! I won't stop now.\""
					)
			</Text>
			<Text id="dallInProgress">
				(cat
					"\"Did you find it? I'm sure those are the right coordinates! "
					"It has to be there. You have to go out there and keep looking!\""
					)
			</Text>
			<Text id="dallSuccess">
				(cat
					"\"It's beautiful! Twenty years of research and now I finally have proof! "
					"Be careful with it! I've got a containment vessel ready for it. You didn't "
					"damage it did you? Good!\"\n\n"
					
					"\"As promised, I have something to help you. I've created an "
					"experimental auton that will explore an entire star system all "
					"by itself. Go and try it out!\""
					)
			</Text>

			<Text id="dallAftermath">
				(cat
					"You find Professor Dall working in his lab. The sphere is inside a massive "
					"containment vessel connected through hundreds of wires to a bank of instruments. "
					"The professor looks up for only a moment:\n\n"

					"\"Yes, I'm making progress, but there are millions of pathways... "
					"There is so much left to understand... and the power curves are immense; you "
					"should see them...\""
					)
			</Text>

			<Text id="actionDontWorry">"\"[D]on't worry about my ship!\""</Text>
			<Text id="actionBeBack">"\"[I]'ll be back.\""</Text>
		</Language>
	</MissionType>

	<!-- Dall Sphere

	GLOBAL DATA
		
	status:			Status of Dall's sphere
						Nil = Never created
						'onFreighter = On the Sung freighter (in containment vessel)
						'found = Retrieved by the player (or otherwise loose in the world)
						'withDall = Returned to Dall by player

	-->

	<ItemType UNID="&itDallSphere;"
			name=				"inert metal sphere"
			level=				"10"
			value=				"0"
			mass=				"1000"
			frequency=			"notRandom"
			attributes=			"alien, notForSale, questItem"

			description=		"This is a one-meter sphere of a dark metal, etched with a network of thin lines and complex shapes."
			>

		<Image imageID="&rsDallSphere;" imageX="0" imageY="0" imageWidth="96" imageHeight="96"/>
		
		<StaticData>
			<00182001_Donation>
				;		attd	rel		text
				'(Nil	-1		200		"This is a remarkable item! Domina will be very pleased!")
			</00182001_Donation>
		</StaticData>
		
		<Events>
			<GetGlobalAchievements>
				(block (theList theStatus)
					(setq theStatus (typGetData &itDallSphere; "status"))
					
					(switch
						(eq theStatus 'found)
							(if (objGetItems gPlayerShip "* +unid:&itDallSphere;")
								(setq theList (list (list "Found Professor Dall's alien sphere" Nil "achievements &amp; regrets")))
								(setq theList (list (list "Found and lost Professor Dall's alien sphere" Nil "achievements &amp; regrets")))
								)
							
						(eq theStatus 'withDall)
							(setq theList (list (list "Found and delivered Professor Dall's alien sphere" Nil "achievements &amp; regrets")))
						)
					
					theList
					)
			</GetGlobalAchievements>

			<OnObjDestroyed>
                (switch
                    
                    ;   If not our object, then nothing to do
                    
                    (!= gSource aObjDestroyed)
                        Nil
						
					;	If the ship we're on got destroyed, but it left a wreck with the
					;	sphere on it, then we're OK.
					
					(and aWreckObj (objGetItems aWreckObj "* +unid:&itDallSphere;"))
						Nil
						
					;	If the ship got destroyed in a gravity well, then the sphere is
					;	permanently destroyed. (Otherwise we would keep creating and
					;	destroying the sphere.)
					
					(= aDestroyReason 'gravity)
						Nil
						
					;	Otherwise, the object drops on its own
                        
					(block (theObj)
						(setq theObj (sysCreateStation &stDallSphere; (objGetPos gSource)))
						(objAddItem theObj (itmCreate &itDallSphere; 1))
						(objIncVel theObj (sysVectorPolarVelocity (random 0 359) 5))
						)
                    )
			</OnObjDestroyed>
			
			<OnUpdate>
				(if (and (not (eq (sysGetNode) "SK")) (eq gSource gPlayerShip))
					(block (roll)
						(setq roll (random 1 100))
						(switch
							(leq roll 4)
								(block Nil
									(objMakeParalyzed gSource 150)
									(objSendMessage gSource Nil "A power surge from the sphere disables your ship")
									)
									
							(leq roll 10)
								(objSendMessage gSource Nil "The sphere in your cargo hold pulses with power")
							)
						)
					)
			</OnUpdate>
		</Events>
	</ItemType>

	<StationType UNID="&stDallSphere;"
			name=				"inert metal sphere"
			sovereign=			"&svNeutral;"
			dockScreen=			"Main"

			scale=				"ship"
			mobile=				"true"
			mass=				"1"
			immutable=			"true" 
			destroyWhenEmpty=	"true"
			noMapIcon=			"true"
			>

		<Image imageID="&rsDallSphere;" imageX="96" imageY="0" imageWidth="32" imageHeight="32"/>

		<DockScreens>
			<Main>
				<Panes>
					<Default>
						<OnPaneInit>
							(switch
								(objGetItems gSource "*")
									(scrSetDescTranslate gScreen 'descFloating)

								(block Nil
									(scrSetDescTranslate gScreen 'descSecure)
									(scrShowAction gScreen 'actionLoot Nil)
									)
								)
						</OnPaneInit>

						<Actions>
							<Action id="actionLoot" default="1" >
								(scrShowScreen gScreen &dsRPGLoot;)
							</Action>

							<Action id="actionUndock" cancel="1">
								<Exit/>
							</Action>
						</Actions>
					</Default>
				</Panes>
			</Main>
		</DockScreens>

		<Language>
			<Text id="actionLoot">"[L]oot"</Text>
			<Text id="actionUndock">"[U]ndock"</Text>

			<Text id="descFloating">"You find an inert metal sphere floating in space."</Text>
			<Text id="descSecure">"The sphere is secure aboard your ship."</Text>
		</Language>

		<DockingPorts
				portCount=		"2"
				portRadius=		"24"
				maxDist=		"3"
				/>
	</StationType>

	<StationType UNID="&stDallMissionWreck;"
			name=				"Sung transport wreck"
			sovereign=			"&svNeutral;"
			dockScreen=			"Main"
			scale=				"ship"
			mobile=				"true"
			noMapIcon=			"true"

			ejectaType=			"&vtWreckEjecta;"
			
			attributes=			"shipwreck"
			>
			
		<Image shipwreckID="&scSungTransport;"/>
		
		<Items>
			<Item item="&itDallSphere;" count="1"/>
		</Items>

		<Ships>
			<Ship	count="4d4+4"	class="&scDwargRaider;"	sovereign="&svDwargRaiders;" orders="patrol"	patrolDist="5" controller="zoanthrope"/>
		</Ships>
		
		<Events>
			<GetExplosionType>
				(intContainerGetExplosionType gSource)
			</GetExplosionType>

			<OnDamage>
				(intContainerOnDamage gSource aDamageHP)
			</OnDamage>
		</Events>

		<DockScreens>
			<Main>
				<InitialPane>
					(switch
						(and (objGetItems gSource "* +unid:&itDallSphere;") 
								(eq (typGetData &itDallSphere; "status") 'onFreighter))
							"ContainmentVessel"

						"Default"
						)
				</InitialPane>
				
				<Panes>
					<Default
							desc=		"You are docked with the wreck of a ship.">

						<Actions>
							<Action name="Loot" key="L" default="1" >
								(scrShowScreen gScreen &dsRPGLoot;)
							</Action>

							<Action name="Jettison" key="J">
								(scrShowScreen gScreen &dsRPGJettison;)
							</Action>

							<Action name="Undock" cancel="1" key="U">
								<Exit/>
							</Action>
						</Actions>
					</Default>
					
					<ContainmentVessel>
						<OnPaneInit>
							(scrSetDesc gScreen (cat
								"You enter the cargo hold of the wrecked ship and see a massive containment vessel "
								"with giant power couplings. Through a thick window in the containment vessel you "
								"see a metal sphere with a complex series of etchings.\n\n"
								"There is an emergency latch on one side that opens the containment vessel."
								))
						</OnPaneInit>

						<Actions>
							<Action name="Open Containment" key="O" default="1">
								(block (
									(theSphere (@ (objGetItems gSource "* +unid:&itDallSphere;") 0))
									(theMission (@ (msnFind "a +unid:&msDallSphere;;") 0))
									)
									
									(objRemoveItem gSource theSphere)
									(objAddItem gPlayerShip theSphere)
									(typSetData &itDallSphere; 'status 'found)
									
									(msnSetData theMission 'targetID (msnGetProperty theMission 'ownerID))
									(msnSetPlayerTarget theMission)
									
									(scrShowPane gScreen "OpenContainment")
									)
							</Action>
							
							<Action name="Undock" key="U" cancel="1">
								(scrExitDock gScreen)
							</Action>
						</Actions>
					</ContainmentVessel>

					<OpenContainment>
						<OnPaneInit>
							(scrSetDesc gScreen (cat
								"The titanic doors of the containment vessel split open and air rushes into it. "
								"The sphere is held in place by thin columns.\n\n"
								"You take the sphere and put it in your cargo hold."
								))
						</OnPaneInit>

						<Actions>
							<Action name="Undock" key="U" default="1" cancel="1">
								(block Nil
									(scrExitDock gScreen)
									)
							</Action>
						</Actions>
					</OpenContainment>
				</Panes>
			</Main>
		</DockScreens>

		<DockingPorts
				portCount=		"2"
				portRadius=		"48"
				maxDist=		"3"
				/>
	</StationType>

<!-- RESOURCES -->

	<Image UNID="&rsDallSphere;"		bitmap="Resources\DallSphere.jpg" bitmask="Resources\DallSphereMask.bmp" loadOnUse="true"/>

</TranscendenceModule>
