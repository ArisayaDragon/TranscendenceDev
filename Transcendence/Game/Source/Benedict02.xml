<?xml version="1.0" encoding="utf-8"?>

<TranscendenceModule>
	
	<!-- Benedict and Fiona ====================================================

	EXTRA DATA

	attackersLeft:			Number of attackers left.
	freighterID:			Target ID to escort.
	stargateID:				Stargate to wait at.

	======================================================================== -->
	
	<MissionType UNID="&msBenedictAndFiona;"
			name=				"Benedict and Fiona"
			attributes=			"benedictStoryArc"

			maxAppearing=		"1"
			debriefAfterOutOfSystem="true"
			failureAfterOutOfSystem="5400"
			>

		<StaticData>
			<sequence>20</sequence>
		</StaticData>

		<Events>
			<OnCreate>
				(block Nil

					(switch
						;	This mission only works in Eridani

						(not (eq (sysGetNode) 'SE))
							(msnDestroy gSource)

						;	Set up the mission

						(block Nil
							)
						)
					)
			</OnCreate>

			<OnAccepted>
				(block (
					(stargateObj (sysFindObject nil "G:Outbound; N"))
					(timeToGate (sysCalcTravelTime (objGetDistance gPlayerShip stargateObj) (shpGetMaxSpeed gPlayerShip)))
					(specialWeapon (itmCreate &itSmartCannon; 1))
					(specialAmmo (itmCreate &itSmartCannonShell; 300))
					)

					;	Give the player a better weapon

					(objAddItem gPlayerShip specialWeapon)
					(objAddItem gPlayerShip specialAmmo)
					(shpInstallDevice gPlayerShip specialWeapon)

					;	Set a timer for when the freighter comes in

					(sysAddObjTimerEvent
						(add timeToGate 300)
						gSource
						"OnFreighterArrives"
						)

					;	Remember the stargate

					(msnSetData gSource 'stargateID (objGetID stargateObj))

					;	Disable hints (so player does not get instructions to enter 
					;	stargate).

					(plyEnableMessage gPlayer 'enabledHints Nil)

					;	Remember that we accepted this mission
					
					(benedict_missionAccepted gSource)
					)
			</OnAccepted>

			<OnAcceptedUndock>
			</OnAcceptedUndock>
			
			<OnDeclined>
			</OnDeclined>
			
			<OnSetPlayerTarget>
				(switch
					;	If we have a freighter ID, then escort it.

					(msnGetData gSource 'freighterID)
						(rpgSetTarget gSource aReason (objGetObjByID (msnGetData gSource 'freighterID)) 'escort)

					;	Otherwise, point to the stargate

					(rpgSetTarget gSource aReason (objGetObjByID (msnGetData gSource 'stargateID)) 'dock)
					)
			</OnSetPlayerTarget>
			
			<OnCompleted>
				(block Nil
					;	Re-enable hints.

					(plyEnableMessage gPlayer 'enabledHints True)
					)
			</OnCompleted>

			<OnReward>
				(block Nil
					;	Give the player a galactic map
					
					(if (eq (objGetEquipmentStatus gPlayerShip 'GalacticMap) 'notInstalled)
						(objChangeEquipmentStatus gPlayerShip 'GalacticMap 'install)
						)
						
					;	Player gets mission to visit Korolov

					(setq theMission (msnCreate &msBenedictToKorolov; Nil))
					(if theMission
						(msnAccept theMission)
						)
						
					Nil
					)
			</OnReward>

			<OnFreighterArrives>
				(block (
					(stargateObj (objGetObjByID (msnGetData gSource 'stargateID)))
					(destObj (objGetObjByID (msnGetProperty gSource 'ownerID)))

					freighterObj
					)

					(plyMessage gPlayer "Freighter arrived!")

					;	Create the freighter and have it exit the gate towards the sisters

					(setq freighterObj (sysCreateShip &scEI7000; stargateObj &svCommonwealth;))
					(shpOrder freighterObj 'dock destObj)
					(msnRegisterForEvents gSource freighterObj)
					(msnSetData gSource 'freighterID (objGetID freighterObj))

					;	Create the enemies and set them to attack the freigther

					(for i 1 3
						(block (enemyObj)
							(setq enemyObj (sysCreateShip &scAtonement; stargateObj &svCult;))
							(shpOrder enemyObj 'attack freighterObj)
							(objSetData enemyObj 'mission (msnGetProperty gSource 'id))
							(msnRegisterForEvents gSource freighterObj)

							;	Set the ships so they don't retreat when shields drop

							(shpSetAISetting enemyObj 'ignoreShieldsDown True)
							)
						)

					(msnSetData gSource 'attackersLeft 3)

					;	Refresh the target

					(msnSetPlayerTarget gSource)
					)
			</OnFreighterArrives>

			<OnObjDestroyed>
				(switch
					(eq (objGetID aObjDestroyed) (msnGetData gSource 'freighterID))
						(msnFailure gSource)

					(eq (objGetData aObjDestroyed 'mission) (msnGetProperty gSource 'id))
						(block Nil
							(msnIncData gSource 'attackersLeft -1)
							)
					)
			</OnObjDestroyed>

			<OnObjDocked>
				(switch
					(eq (objGetID aObjDocked) (msnGetData gSource 'freighterID))
						(block Nil
							;	Mission success

							(msnSuccess gSource)

							;	Attacking ships retreat

							(enum (sysFindObject aObjDocked "sO:attack") enemyObj
								(shpCancelOrders enemyObj)
								)
							)
					)
			</OnObjDocked>
		</Events>
		
		<Language>
			<Text id="Name">
				"Defend Returning Freighter"
			</Text>
			<Text id="Summary">
				(cat
					"Meet the freighter at the stargate and defend it back to the station.\n\n"
					
					"System: Eridani\n"
					"Payment: None"
					)
			</Text>
			<Text id="Intro">
			</Text>
			<Text id="Briefing">
			</Text>
			<Text id="AcceptReply">
			</Text>
			<Text id="DeclineReply">
			</Text>
			<Text id="InProgress">
				(cat
					"Benedict rushes out to meet you.\n\n"
					
					"\"What are you doing here? They need you out there!\""
					)
			</Text>
			<Text id="SuccessDebrief">
				(list
					{	desc: (cat
							"The docking bay swarms with activity. Techs hook up "
							"cables and equipment to the docked freighter while "
							"Benedict and the abbess talk with the freighter's captain.\n\n"
							
							"\"...the Penitents hit them hard,\" says the captain. "
							"\"There was no trace of the explorer ship; we just found "
							"her drifting in space. She must have ejected...\"\n\n"
							
							"Behind them you see cardinal-robed medics maneuver a "
							"rejuv tank through the bay. Inside you see an unconscious "
							"woman, her long black hair waving in the tank's fluid."
							)
						}
					{	desc: (cat
							"Benedict makes his way towards you.\n\n"
							
							"\"Thank you for helping us,\" he says, shaking your hand. "
							"\"They wouldn't have survived without you.\""
							)
							
						nextLabel: "\"Who is the woman in the tank?\""
						}
					{	desc: (cat
							"Benedict looks across the docking bay at the rejuv tank "
							"and for the first time you see tears in his eyes.\n\n"
							
							"\"I should have never let her go,\" he says, mostly to himself.\n\n"
							
							"\"Penitents attacked her exploration ship, just as they "
							"were about to make a critical discovery. Now their data "
							"is lost along with the ship and crew. She's all we have left.\""
							)
						nextLabel: "\"Who are the Penitents?\""
						}
					{	desc: (cat
							"Anger flashes across Benedict's face.\n\n"
							
							"\"Domina is not the only god, you know? The Penitents worship "
							"Oracus, their god of death. But they've gotten stronger "
							"in the last few years. I've never seen them come all the "
							"way to Eridani before.\n\n"
							
							"\"They've got my attention now.\""
							)
						}
					{	desc: (cat
							"\"But your task here is done. Your fate is to reach the Galactic "
							"Core&#x97;or die trying. I hope I've taught you enough.\n\n"
							
							"\"I have one more gift for you: I've installed a map computer "
							"on your ship that will help you chart your course through the galaxy.\""
							)
						nextLabel: "\"Thank you!\""
						}
						
					(block (
						(korolovMsn (@ (msnFind "a +unid:&msBenedictToKorolov;;") 0))
						)
						
						(if korolovMsn
							{
							desc: (cat
								"\"Remember what I've taught you and you'll be fine.\n\n"
								
								"\"You've shown aptitude for defending ships; if you're interested "
								"you can visit Korolov Shipping in the " (sysGetName (msnGetData korolovMsn 'korolovNodeID)) " system. "
								"They're always looking for skilled pilots to defend their freighters.\n\n"
								
								"\"Goodbye, %name%! Perhaps I'll see you again someday.\""
								)
							}
							
							{
							desc: (cat
								"\"Goodbye, %name%! Perhaps I'll see you again someday.\""
								)
							}
							)
						)
					)
			</Text>
			<Text id="SuccessMsg">
				"Mission complete!"
			</Text>
		</Language>
	</MissionType>

</TranscendenceModule>
