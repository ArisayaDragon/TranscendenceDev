<?xml version="1.0" encoding="utf-8"?>

<TranscendenceModule>
	
	<!-- Benedict and Fiona ====================================================

	EXTRA DATA

	attackersLeft:			Number of attackers left.
	freighterID:			Target ID to escort.
	stargateID:				Stargate to wait at.

	======================================================================== -->
	
	<MissionType UNID="&msBenedictAndFiona;"
			name=				"Benedict and Fiona"
			attributes=			"benedictStoryArc"

			maxAppearing=		"1"
			debriefAfterOutOfSystem="true"
			failureAfterOutOfSystem="5400"
			>

		<StaticData>
			<sequence>20</sequence>
		</StaticData>

		<Events>
			<OnCreate>
				(block Nil

					(switch
						;	This mission only works in Eridani

						(not (eq (sysGetNode) 'SE))
							(msnDestroy gSource)

						;	See if the mission is still available

						(not (benedict_isMissionAvailable &msBenedictAndFiona;))
							(msnDestroy gSource)

						;	Set up the mission

						(block Nil
							)
						)
					)
			</OnCreate>

			<OnAccepted>
				(block (
					(stargateObj (sysFindObject nil "G:Outbound; N"))
					(timeToGate (sysCalcTravelTime (objGetDistance gPlayerShip stargateObj) (shpGetMaxSpeed gPlayerShip)))
					(specialWeapon (itmCreate &itSmartCannon; 1))
					(specialAmmo (itmCreate &itSmartCannonShell; 300))
					)

					;	Give the player a better weapon

					(objAddItem gPlayerShip specialWeapon)
					(objAddItem gPlayerShip specialAmmo)
					(shpInstallDevice gPlayerShip specialWeapon)

					;	Set a timer for when the freighter comes in

					(sysAddObjTimerEvent
						(add timeToGate 300)
						gSource
						"OnFreighterArrives"
						)

					;	Remember the stargate

					(msnSetData gSource 'stargateID (objGetID stargateObj))

					;	Disable hints (so player does not get instructions to enter 
					;	stargate).

					(plyEnableMessage gPlayer 'enabledHints Nil)

					;	Remember that we accepted this mission
					
					(benedict_missionAccepted gSource)
					)
			</OnAccepted>

			<OnAcceptedUndock>
			</OnAcceptedUndock>
			
			<OnDeclined>
			</OnDeclined>
			
			<OnSetPlayerTarget>
				(switch
					;	If we have a freighter ID, then escort it.

					(msnGetData gSource 'freighterID)
						(rpgSetTarget gSource aReason (objGetObjByID (msnGetData gSource 'freighterID)) 'escort)

					;	Otherwise, point to the stargate

					(rpgSetTarget gSource aReason (objGetObjByID (msnGetData gSource 'stargateID)) 'dock)
					)
			</OnSetPlayerTarget>
			
			<OnCompleted>
				(block Nil
					;	Re-enable hints.

					(plyEnableMessage gPlayer 'enabledHints True)
					)
			</OnCompleted>

			<OnReward>
				(block Nil
					;	Player gets mission to visit Korolov

					(setq theMission (msnCreate &msBenedictToKorolov; Nil))
					(if theMission
						(msnAccept theMission)
						)
					)
			</OnReward>

			<OnFreighterArrives>
				(block (
					(stargateObj (objGetObjByID (msnGetData gSource 'stargateID)))
					(destObj (objGetObjByID (msnGetProperty gSource 'ownerID)))

					freighterObj
					)

					(plyMessage gPlayer "Freighter arrived!")

					;	Create the freighter and have it exit the gate towards the sisters

					(setq freighterObj (sysCreateShip &scEI7000; stargateObj &svCommonwealth;))
					(shpOrder freighterObj 'dock destObj)
					(msnRegisterForEvents gSource freighterObj)
					(msnSetData gSource 'freighterID (objGetID freighterObj))

					;	Create the enemies and set them to attack the freigther

					(for i 1 3
						(block (enemyObj)
							(setq enemyObj (sysCreateShip &scAtonement; stargateObj &svCult;))
							(shpOrder enemyObj 'attack freighterObj)
							(objSetData enemyObj 'mission (msnGetProperty gSource 'id))
							(msnRegisterForEvents gSource freighterObj)

							;	Set the ships so they don't retreat when shields drop

							(shpSetAISetting enemyObj 'ignoreShieldsDown True)
							)
						)

					(msnSetData gSource 'attackersLeft 3)

					;	Refresh the target

					(msnSetPlayerTarget gSource)
					)
			</OnFreighterArrives>

			<OnObjDestroyed>
				(switch
					(eq (objGetID aObjDestroyed) (msnGetData gSource 'freighterID))
						(msnFailure gSource)

					(eq (objGetData aObjDestroyed 'mission) (msnGetProperty gSource 'id))
						(block Nil
							(msnIncData gSource 'attackersLeft -1)
							)
					)
			</OnObjDestroyed>

			<OnObjDocked>
				(switch
					(eq (objGetID aObjDocked) (msnGetData gSource 'freighterID))
						(block Nil
							;	Mission success

							(msnSuccess gSource)

							;	Attacking ships retreat

							(enum (sysFindObject aObjDocked "sO:attack") enemyObj
								(shpCancelOrders enemyObj)
								)
							)
					)
			</OnObjDocked>
		</Events>
		
		<Language>
			<Text id="Name">
				"Benedict and Fiona"
			</Text>
			<Text id="Summary">
				(cat
					"Escort a freighter"
					)
			</Text>
			<Text id="Intro">
				(cat
					"LATER: OK, we want you to escort a frieghter."
					)
			</Text>
			<Text id="Briefing">
				(cat
					"LATER: Don't let it be destroyed."
					)
			</Text>
			<Text id="AcceptReply">
				(cat
					"LATER: Go!"
					)
			</Text>
			<Text id="DeclineReply">
				"LATER: Sucks!"
			</Text>
			<Text id="InProgress">
				(cat
					"LATER: Get back out there."
					)
			</Text>
			<Text id="SuccessDebrief">
				(block (
					(korolovMsn (@ (msnFind "a +unid:&msBenedictToKorolov;;") 0))
					)

					(list
						(cat
							"LATER: Great!"
							)
						(if korolovMsn
							(cat
								"LATER: Go to " (sysGetName (msnGetData korolovMsn 'korolovNodeID)) " and find the Korolov station."
								)
							(cat
								"LATER: Maybe I'll see you again"
								)
							)
						)
					)
			</Text>
			<Text id="SuccessMsg">
				"Mission complete!"
			</Text>
		</Language>
	</MissionType>

</TranscendenceModule>
