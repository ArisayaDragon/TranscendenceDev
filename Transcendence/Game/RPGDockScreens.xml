<?xml version="1.0" encoding="utf-8"?>

<TranscendenceModule>

<!-- INSTALL DEVICE SCREEN =====================================================

	This screen asks the user to pick a device from a list of itemStructs and
	then installs the device (charging appropriately).

	gData uses the following fields:

	itemList:			This is a list of device itemStructs that we should 
						offer to install for the player.

	priceAdj:			A percent of standard price to charge. If Nil, we use
						the source's Trade directives. If an integer, we treat
						it as a % price adjustment (100 = 100% of price). If a
						function, we evaluate it to determine the price.

	installPriceAdj:	The price to install the device. If Nil, we use the 
						item's default install price. If an integer, we treat it
						as a % price adjustment. If a function, we evaluate it
						to determine the price.

	checkMilitaryID:	If True we check to make sure the player has a military
						ID before selling them a military reactor.

	noItemsText:		Text to show if itemList is empty

-->

	<DockScreen UNID="&dsRPGInstallDeviceFromList;"
			type=           "customItemPicker"
			backgroundID=   "&rsItemListScreen;"
			nestedScreen=   "true"
			>

        <List>
			(@ gData 'itemList)
        </List>

        <Panes>
            <Default>
                <onPaneInit>
					(block (result)
						(setq gItem (scrGetItem gScreen))

						(if gItem
							(block (result)
								(setq gCost
									(add
										(rpgAdjustPrice gSource gItem (@ gData 'priceAdj) (objGetDefaultCurrency gSource) 'noInventoryCheck)
										(rpgAdjustInstallPrice gSource gItem (@ gData 'installPriceAdj) (objGetDefaultCurrency gSource))
										)
									)

								(setq result (rpgInstallDevicePrep
									{
									item: gItem
									totalPrice: gCost
									currencyUsed: (objGetDefaultCurrency gSource)
									checkMilitaryID: True
									}))

								(scrSetDesc gScreen (@ result 'desc))
								(scrEnableAction gScreen 0 (@ result 'canInstall))
								)

							; No items in list
							(block Nil
								(scrSetDesc gScreen
									(if (@ gData 'noItemsText)
										(@ gData 'noItemsText)
										"You cannot install any items."
										)
									)
								(scrEnableAction gScreen 0 Nil)
								)
							)
						)
                </onPaneInit>

                <Actions>
                    <Action name="Buy &amp; Install this item" default="1" key="B">
						(block Nil
							(rpgBuyItem gSource gItem gCost (objGetDefaultCurrency gSource))
							(shpInstallDevice gPlayerShip gItem)
							(scrShowPane gScreen "InstallSuccess")
							)
                    </Action>

                    <Action name="Cancel" cancel="1" key="C">
                        (scrExitScreen gScreen)
                    </Action>
                </Actions>
            </Default>

			<InstallSuccess
					noListNavigation="true"
					>
				<OnPaneInit>
					(block Nil
						(scrSetDesc gScreen
							(cat (itmGetName gItem 0x01) " installed successfully.")
							)
						)
				</OnPaneInit>

				<Actions>
					<Action name="Continue" default="1" cancel="1" key="C">
                        (scrExitScreen gScreen)
					</Action>
				</Actions>
			</InstallSuccess>
        </Panes>
    </DockScreen>

</TranscendenceModule>
